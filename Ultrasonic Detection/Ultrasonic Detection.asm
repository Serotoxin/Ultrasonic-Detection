	ORG 0000H
MLOOP:  LCALL LCDINIT
	LCALL SRINIT
	LCALL KEY
	LCALL LCDBG
MLOOP1: NOP
	LCALL SRTRIG
	LCALL MESURE
	LCALL BCDTRS

	MOV R2,#89H
	MOV A,R5
	MOV R3,A
	LCALL LCDSHOW

	MOV R2,#8AH
	MOV A,R4
	MOV R3,A
	LCALL LCDSHOW

	MOV R2,#8BH
	MOV A,R1
	MOV R3,A
	LCALL LCDSHOW

	MOV R2,#8CH
	MOV A,R0
	MOV R3,A
	LCALL LCDSHOW

	LCALL BEEP
	LCALL STOP
	MOV TH0,#0
	MOV TL0,#0
	LCALL LCDANM
	SJMP MLOOP1	




	ORG 0200H
KEY:	JNB P3.1,OUT ;启动按钮
	SJMP KEY

OUT:	SETB P3.0
	RET

STOP:	JB P3.0,OUT
	SJMP KEY
	RET


	ORG 0300H ;延时
DEL10US:MOV R7,#100
DEL1:	DJNZ R7,DEL1
	RET

DEL1MS: MOV R6,#10
DEL2:   LCALL DEL10US
	DJNZ R6,DEL2
	RET

DEL100MS:MOV R5,#100
DEL3:   LCALL DEL1MS
	DJNZ R5,DEL3
	RET	


	ORG 0400H;蜂鸣器条件判断和循环
BEEP:	MOV A,TH0
	CJNE A,#01H,SHORT
SHORT:	JC SHORTB
	CJNE A,#06H,MIDDLE
MIDDLE: JC MIDDLEB
	CJNE A,#10H,LONG
LONG:	JC LONGB
OVERRANGE:RET

MIDDLEB:LCALL BEEP2
	RET

LONGB:	LCALL BEEP3
	RET

SHORTB:	LCALL BEEP1
	RET


BEEP1:	MOV R0,#10
	MOV R1,#10
	MOV R2,#2
	
BLOOP:  NOP
BLOOP0:	SETB P2.5
	LCALL DEL10US
	CLR P2.5
	LCALL DEL10US
	DJNZ R0,BLOOP0

BLOOP1:	SETB P2.5
	LCALL DEL10US
	LCALL DEL10US
	CLR P2.5
	LCALL DEL10US
	LCALL DEL10US
	DJNZ R1,BLOOP1

	DJNZ R2,BLOOP
	RET

BEEP2:	MOV R0,#10
	MOV R1,#10
	MOV R2,#2	
BLOOP2: NOP

BLOOP3:	SETB P2.5
	LCALL DEL10US
	LCALL DEL10US
	CLR P2.5
	LCALL DEL10US
	LCALL DEL10US
	DJNZ R0,BLOOP3

BLOOP4:	SETB P2.5
	LCALL DEL10US
	LCALL DEL10US
	LCALL DEL10US
	CLR P2.5
	LCALL DEL10US
	LCALL DEL10US
	LCALL DEL10US
	DJNZ R1,BLOOP4

	DJNZ R2,BLOOP2
	RET

BEEP3:	MOV R0,#10
	MOV R1,#10
	MOV R2,#2
	
BLOOP5: NOP
BLOOP6:	SETB P2.5
	LCALL DEL10US
	LCALL DEL10US
	LCALL DEL10US
	LCALL DEL10US
	CLR P2.5
	LCALL DEL10US
	LCALL DEL10US
	LCALL DEL10US
	LCALL DEL10US
	DJNZ R0,BLOOP6

BLOOP7:	SETB P2.5
	LCALL DEL10US
	LCALL DEL10US
	LCALL DEL10US
	LCALL DEL10US
	LCALL DEL10US
	CLR P2.5
	LCALL DEL10US
	LCALL DEL10US
	LCALL DEL10US
	LCALL DEL10US
	LCALL DEL10US
	DJNZ R1,BLOOP7
	DJNZ R2,BLOOP5
	RET




	ORG 0500H;计时器相关计算
TMINIT: MOV TMOD,#01H
	MOV TH0,#0
	MOV TL0,#0
	CLR TR0
	RET
				
SRINIT: CLR P2.0
	CLR P2.1
	ACALL TMINIT
	RET

SRTRIG: SETB P2.1
	LCALL DEL10US
	LCALL DEL10US
	LCALL DEL10US
	CLR P2.1
	RET

MESURE: JNB P2.0,MESURE ;这里1.7近似2，除法中不包括任何小数，因为懒
	SETB TR0
X1:	JB P2.0,X1
 	CLR TR0
	;mov th0,#0FFH
	;mov tl0,#0FFH
CALC:	MOV R7,#0
	JNB TF0,N1
	MOV R7,#5
N1:	MOV A,TH0;r7代表除完之后的高八位，r6代表低八位
	MOV B,#5
	MUL AB
	MOV R5,A
	MOV A,B
	ADD A,R7
	MOV R7,A
	MOV A,R5
	

	JNC N2
	MOV R5,A
	MOV A,#1
	ADD A,R7
	MOV R7,A;高八位配置
	MOV A,R5	

N2:	MOV R0,A
	MOV A,TL0	
	JNC N3
	MOV R5,A
	MOV A,#1
	ADD A,R7
	MOV R7,A
	MOV A,R5;高八位配置完毕
N3:	MOV B,#50
	DIV AB	
	ADD A,R0
	MOV R6,A;低八位配置完毕
 	RET

BCDTRS:	MOV A,R6;R6R7
	MOV B,#10
	DIV AB
	MOV R0,B;个位初值R0

	MOV B,#10
	DIV AB
	MOV R1,B;十位初值R1

	MOV B,#10
	DIV AB
	MOV R4,B;百位初值R4
			
	MOV A,R7
	MOV B,#6
	MUL AB
	MOV B,#10
	DIV AB
	MOV R5,A;暂存进位值，下一步修正
	MOV A,B
	ADD A,R0;得到一个十位数
	MOV B,#10
	DIV AB
	MOV R0,B;真正的个位
	ADD A,R5
	MOV R5,A;下一位进位的所有值
	
	MOV A,R7
	MOV B,#5
	MUL AB
	ADD A,R5;加上进位位，释放R5
	MOV B,#10
	DIV AB
	MOV R5,A;暂存进位值，下一步修正
	MOV A,B
	ADD A,R1;得到一个十位数
	MOV B,#10
	DIV AB
	MOV R1,B;真正的十位
	ADD A,R5
	MOV R5,A;下一位进位的所有值

	MOV A,R7
	MOV B,#2
	MUL AB
	ADD A,R5;加上进位位，释放R5
	MOV B,#10
	DIV AB
	MOV R5,A;暂存进位值，下一步修正
	MOV A,B
	ADD A,R4;得到一个十位数
	MOV B,#10
	DIV AB
	MOV R4,B;真正的百位
	ADD A,R5
	MOV R5,A;下一位进位的所有值

	MOV A,#30H
	ADD A,R5
	MOV R5,A

	MOV A,#30H
	ADD A,R4
	MOV R4,A

	MOV A,#30H
	ADD A,R1
	MOV R1,A

	MOV A,#30H
	ADD A,R0
	MOV R0,A

	RET




	ORG 0600H
LCDINIT:MOV R2,#38H
	LCALL LCDWCM
	MOV R2,#0CH
	LCALL LCDWCM
	MOV R2,#06H
	LCALL LCDWCM
	MOV R2,#01H
	LCALL LCDWCM
	RET

LCDBG:	MOV R2,#80H
	MOV R3,#01000100B;D
	LCALL LCDSHOW

	MOV R2,#81H
	MOV R3,#01001001B;I
	LCALL LCDSHOW

	MOV R2,#82H
	MOV R3,#01010011B;S
	LCALL LCDSHOW

	MOV R2,#83H
	MOV R3,#01010100B;T
	LCALL LCDSHOW

	MOV R2,#84H
	MOV R3,#01000001B;A
	LCALL LCDSHOW

	MOV R2,#85H
	MOV R3,#01001110B;N
	LCALL LCDSHOW

	MOV R2,#86H
	MOV R3,#01000011B;C
	LCALL LCDSHOW

	MOV R2,#87H
	MOV R3,#01000101B;E
	LCALL LCDSHOW

	MOV R2,#88H
	MOV R3,#00111010B;:
	LCALL LCDSHOW

	MOV R2,#8DH
	MOV R3,#01000011B;C
	LCALL LCDSHOW

	MOV R2,#08EH
	MOV R3,#01001101B;M
	LCALL LCDSHOW
	RET

LCDJUDG:

LCDWCM:	CLR P2.6
	CLR P2.5
	MOV P0,R2
	SETB P2.7
	LCALL DEL1MS
	CLR P2.7
 	LCALL DEL1MS
	RET

LCDWDATA:NOP
	SETB P2.6
	CLR P2.5
	MOV P0,R3
	SETB P2.7  
	LCALL DEL1MS
	CLR P2.7
	LCALL DEL1MS
	RET	

LCDSHOW:LCALL LCDWCM
	LCALL DEL1MS
	LCALL LCDWDATA
	RET


LCDANM:	MOV R2,#0C0H
	MOV R3,#01000100B;D
	LCALL LCDSHOW
	MOV R2,#0C1H
	MOV R3,#01000101B;E
	LCALL LCDSHOW
	MOV R2,#0C2H
	MOV R3,#01010100B;T
	LCALL LCDSHOW
	MOV R2,#0C3H
	MOV R3,#01000101B;E
	LCALL LCDSHOW
	MOV R2,#0C4H
	MOV R3,#01000011B;C
	LCALL LCDSHOW
	MOV R2,#0C5H
	MOV R3,#01010100B;T
	LCALL LCDSHOW
	MOV R2,#0C6H
	MOV R3,#01001001B;I
	LCALL LCDSHOW
	MOV R2,#0C7H
	MOV R3,#01001110B;N
	LCALL LCDSHOW
	MOV R2,#0C8H
	MOV R3,#01000111B;G
	LCALL LCDSHOW
	LCALL DEL100MS
	MOV R2,#0C0H
	MOV R3,#00100000B;D
	LCALL LCDSHOW
	MOV R2,#0C1H
	MOV R3,#00100000B;E
	LCALL LCDSHOW
	MOV R2,#0C2H
	MOV R3,#00100000B;T
	LCALL LCDSHOW
	MOV R2,#0C3H
	MOV R3,#00100000B;E
	LCALL LCDSHOW
	MOV R2,#0C4H
	MOV R3,#00100000B;C
	LCALL LCDSHOW
	MOV R2,#0C5H
	MOV R3,#00100000B;T
	LCALL LCDSHOW
	MOV R2,#0C6H
	MOV R3,#00100000B;I
	LCALL LCDSHOW
	MOV R2,#0C7H
	MOV R3,#00100000B;N
	LCALL LCDSHOW
	MOV R2,#0C8H
	MOV R3,#00100000B;G
	LCALL LCDSHOW
	RET

	END

